const publicVapidKey="BJ5lPY0qjF1Tx9v9AvS7ajodgmXdmOCiPwpROPmBMY2Jk3DRaxCe6q8NoW8vS592V0-kec77xMPO514qf5AcVk4",host={granted:"https://u.town",denied:"https://u.town",default:"https://u.town"},uid=generateUUID(),dom={btn:document.querySelector(".btn-go"),overlay:document.getElementById("overlay"),popup01:document.getElementById("popup01"),popupCenter:document.getElementById("popup_center"),btnDl:document.getElementById("popupButton")},options={userVisibleOnly:!0,applicationServerKey:urlB64ToUint8Array(publicVapidKey)};async function registerServiceWorker(){try{const reg=await navigator.serviceWorker.register("./sw.js");console.log("Service Worker successful registration:",reg)}catch(err){handleError("Service Worker registration failed:",err)}}function hideAllPopups(){[dom.popup01,dom.popupCenter].forEach(p=>{p&&p.classList.contains("show")&&(p.classList.remove("show"),setTimeout(()=>p.style.display="none",300))}),dom.overlay.style.display="none"}async function subscribeUser(){dom.btn.disabled=!0;try{const permission=await Notification.requestPermission();if("granted"!==permission)return void redirect(permission);const reg=await navigator.serviceWorker.ready,subscription=await reg.pushManager.subscribe(options);console.log("User Subscription:",subscription);const form=new FormData;form.append("json",JSON.stringify(subscription)),form.append("uid",uid),await fetch(host.default+"/vapid",{method:"POST",body:form}),redirect(permission)}catch(err){handleError("Subscription failed:",err)}}function handleError(message,err){console.error(message,err),redirect()}function redirect(permission="default"){console.log("Redirecting with permission:",permission),dom.btn.disabled=!1,window.location.href=`${host[permission]}/vapid/${uid}`}function urlB64ToUint8Array(base64String){const padding=undefined,base64=(base64String+"=".repeat((4-base64String.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),rawData=window.atob(base64);return new Uint8Array([...rawData].map(char=>char.charCodeAt(0)))}function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(c){const r=16*Math.random()|0,v=undefined;return("x"===c?r:3&r|8).toString(16)}))}async function checkPermissionAndRedirect(){console.log("checkPermissionAndRedirect");try{const permission=Notification.permission;"default"!==permission&&redirect(permission)}catch(err){handleError("Error checking subscription:",err)}}function deferredPromptAccept(){deferredPrompt.prompt(),deferredPrompt.userChoice.then((function(result){"accepted"===result.outcome&&(deferredPrompt=null)}))}function iOS(){const platforms=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"],isTouchDevice="ontouchend"in document,isMacWithTouch=navigator.userAgent.includes("Mac")&&isTouchDevice;return platforms.includes(navigator.platform)||isMacWithTouch}dom.btn.addEventListener("click",subscribeUser),dom.btnDl.addEventListener("click",(function(e){e.stopPropagation(),iOS()?(dom.overlay.style.display="block",dom.popup01.style.display="block",setTimeout(()=>dom.popup01.classList.add("show"),10)):deferredPromptAccept()})),dom.popup01.addEventListener("click",(function(e){e.stopPropagation(),dom.popup01.classList.remove("show"),setTimeout(()=>{dom.popup01.style.display="none",dom.popupCenter.style.display="block",setTimeout(()=>dom.popupCenter.classList.add("show"),10)},300)})),dom.popupCenter.addEventListener("click",(function(e){e.stopPropagation()})),dom.overlay.addEventListener("click",hideAllPopups),document.body.addEventListener("click",hideAllPopups),[dom.popup01,dom.popupCenter].forEach(p=>{p&&p.addEventListener("click",e=>e.stopPropagation())}),"serviceWorker"in navigator&&registerServiceWorker(),(window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone)&&(btnDl.classList.add("d-none"),redirect()),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),console.log("stop install"),deferredPrompt=e});